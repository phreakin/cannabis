{% extends "base.html" %}
{% block title %}{{ 'Edit' if action == 'edit' else 'New' }} Source — Cannabis Data Aggregator{% endblock %}
{% block page_title %}{{ 'Edit Source' if action == 'edit' else 'New Data Source' }}{% endblock %}

{% block topbar_actions %}
<a href="/sources" class="btn btn-sm btn-outline-secondary">
  <i class="bi bi-arrow-left me-1"></i> Back to Sources
</a>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-9">

    <form id="sourceForm">
      <!-- BASIC INFO -->
      <div class="card mb-3">
        <div class="card-header">Basic Information</div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Source ID <span class="text-danger">*</span></label>
              <input type="text" class="form-control" name="source_id"
                     value="{{ source.source_id if source else '' }}"
                     placeholder="e.g., co_med_licensees" required
                     pattern="[a-z0-9_]+" title="Lowercase letters, numbers, and underscores only"
                     {% if action == 'edit' %}readonly{% endif %}>
              <div class="form-text">Unique identifier (lowercase, underscores). Cannot be changed after creation.</div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Display Name <span class="text-danger">*</span></label>
              <input type="text" class="form-control" name="name"
                     value="{{ source.name if source else '' }}"
                     placeholder="e.g., Colorado MED Licensed Facilities" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">State <span class="text-danger">*</span></label>
              <select class="form-select" name="state" required>
                <option value="">Select state...</option>
                <option value="FEDERAL" {% if source and source.state == 'FEDERAL' %}selected{% endif %}>FEDERAL</option>
                {% for abbr in ['AK','AL','AR','AZ','CA','CO','CT','DC','DE','FL','GA','HI',
                                 'IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN',
                                 'MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH',
                                 'OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA',
                                 'WI','WV','WY'] %}
                <option value="{{ abbr }}" {% if source and source.state == abbr %}selected{% endif %}>{{ abbr }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Category <span class="text-danger">*</span></label>
              <select class="form-select" name="category" required>
                <option value="">Select category...</option>
                {% for cat in ['dispensaries','cultivators','processors','manufacturers','transporters',
                               'distributors','labs','medical_providers','licenses','sales',
                               'products','brands','laws','violations','lab_results','seed_to_sale'] %}
                <option value="{{ cat }}" {% if source and source.category == cat %}selected{% endif %}>{{ cat }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Subcategory</label>
              <input type="text" class="form-control" name="subcategory"
                     value="{{ source.subcategory if source else '' }}"
                     placeholder="e.g., retail, medical">
            </div>
            <div class="col-12">
              <label class="form-label">Agency / Department</label>
              <input type="text" class="form-control" name="agency"
                     value="{{ source.agency if source else '' }}"
                     placeholder="e.g., Marijuana Enforcement Division (MED)">
            </div>
            <div class="col-12">
              <label class="form-label">Description</label>
              <textarea class="form-control" name="description" rows="2">{{ source.description if source else '' }}</textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- ENDPOINT CONFIG -->
      <div class="card mb-3">
        <div class="card-header">Endpoint Configuration</div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label">Format <span class="text-danger">*</span></label>
              <select class="form-select" name="format" id="formatSelect" required>
                <option value="">Select format...</option>
                <option value="soda" {% if source and source.format == 'soda' %}selected{% endif %}>SODA (Socrata API)</option>
                <option value="json" {% if source and source.format == 'json' %}selected{% endif %}>JSON REST API</option>
                <option value="csv" {% if source and source.format == 'csv' %}selected{% endif %}>CSV Download</option>
                <option value="geojson" {% if source and source.format == 'geojson' %}selected{% endif %}>GeoJSON</option>
                <option value="xml" {% if source and source.format == 'xml' %}selected{% endif %}>XML</option>
              </select>
            </div>
            <div class="col-md-9">
              <label class="form-label">Endpoint URL <span class="text-danger">*</span></label>
              <input type="url" class="form-control" name="url"
                     value="{{ source.url if source else '' }}"
                     placeholder="https://data.state.gov/resource/dataset-id.json">
            </div>
            <div class="col-md-6">
              <label class="form-label">Discovery / Documentation URL</label>
              <input type="url" class="form-control" name="discovery_url"
                     value="{{ source.discovery_url if source else '' }}"
                     placeholder="https://data.state.gov/browse?q=cannabis">
            </div>
            <div class="col-md-6">
              <label class="form-label">Agency Website</label>
              <input type="url" class="form-control" name="website"
                     value="{{ source.website if source else '' }}"
                     placeholder="https://www.agency.gov">
            </div>

            <!-- API Key -->
            <div class="col-12">
              <div class="form-check form-switch mb-2">
                <input class="form-check-input" type="checkbox" name="api_key_required"
                       id="apiKeyRequired"
                       {{ 'checked' if source and source.api_key_required else '' }}
                       onchange="document.getElementById('apiKeySection').style.display=this.checked?'':'none'">
                <label class="form-check-label" for="apiKeyRequired">Requires API Key</label>
              </div>
              <div id="apiKeySection" style="display:{{ 'block' if source and source.api_key_required else 'none' }};">
                <label class="form-label">API Key Environment Variable</label>
                <input type="text" class="form-control" name="api_key_env"
                       value="{{ source.api_key_env if source else '' }}"
                       placeholder="e.g., CO_APP_TOKEN, SOCRATA_APP_TOKEN">
                <div class="form-text">Name of the environment variable containing the API key (not the key itself).</div>
              </div>
            </div>

            <!-- Request Settings -->
            <div class="col-md-4">
              <label class="form-label">Rate Limit (req/min)</label>
              <input type="number" class="form-control" name="rate_limit_rpm"
                     value="{{ source.rate_limit_rpm if source else '60' }}" min="1" max="1000">
            </div>
            <div class="col-md-4">
              <label class="form-label">Timeout (seconds)</label>
              <input type="number" class="form-control" name="timeout"
                     value="{{ source.timeout if source else '60' }}" min="5" max="600">
            </div>
            <div class="col-md-4 d-flex align-items-end">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" name="enabled"
                       id="sourceEnabled"
                       {{ 'checked' if (not source or source.enabled) else '' }}>
                <label class="form-check-label fw-semibold" for="sourceEnabled">Enabled</label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ADVANCED: PARAMS & PAGINATION -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between">
          Advanced Configuration
          <button type="button" class="btn btn-sm btn-link p-0" data-bs-toggle="collapse"
                  data-bs-target="#advancedSection">Toggle</button>
        </div>
        <div class="collapse {% if source and (source.params or source.pagination or source.field_mapping) %}show{% endif %}"
             id="advancedSection">
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Query Parameters (JSON)</label>
                <textarea class="form-control font-monospace" name="params" rows="5"
                          style="font-size:.8rem;">{{ source.params | tojson(indent=2) if source and source.params else '{\n  "$limit": 5000,\n  "$offset": 0\n}' }}</textarea>
                <div class="form-text">Default query parameters as JSON object.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Pagination Config (JSON)</label>
                <textarea class="form-control font-monospace" name="pagination" rows="5"
                          style="font-size:.8rem;">{{ source.pagination | tojson(indent=2) if source and source.pagination else '{\n  "type": "offset",\n  "limit_param": "$limit",\n  "offset_param": "$offset",\n  "page_size": 5000\n}' }}</textarea>
                <div class="form-text">Pagination type: none, offset, page, cursor, link.</div>
              </div>
              <div class="col-12">
                <label class="form-label">Field Mapping (JSON)</label>
                <textarea class="form-control font-monospace" name="field_mapping" rows="8"
                          style="font-size:.8rem;">{{ source.field_mapping | tojson(indent=2) if source and source.field_mapping else '{\n  "name": "business_name",\n  "license_number": "license_no",\n  "address": "address",\n  "city": "city",\n  "state": "state",\n  "zip_code": "zip",\n  "latitude": "location.latitude",\n  "longitude": "location.longitude"\n}' }}</textarea>
                <div class="form-text">Maps standard field names to source field names. Use dot notation for nested fields (e.g., "location.latitude").</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Custom Headers (JSON)</label>
                <textarea class="form-control font-monospace" name="headers" rows="4"
                          style="font-size:.8rem;">{{ source.headers | tojson(indent=2) if source and source.headers else '{}' }}</textarea>
              </div>
              <div class="col-md-6">
                <label class="form-label">Tags (comma-separated)</label>
                <input type="text" class="form-control" name="tags"
                       value="{{ (source.tags or []) | join(', ') if source else '' }}"
                       placeholder="colorado, dispensaries, licenses">
                <label class="form-label mt-3">Notes</label>
                <textarea class="form-control" name="notes" rows="3">{{ source.notes if source else '' }}</textarea>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ACTIONS -->
      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-check-lg me-1"></i>
          {{ 'Save Changes' if action == 'edit' else 'Create Source' }}
        </button>
        {% if action == 'edit' %}
        <button type="button" class="btn btn-outline-success"
                onclick="testSource({{ source.id }}, '{{ source.name }}')">
          <i class="bi bi-wifi me-1"></i> Test Connection
        </button>
        <button type="button" class="btn btn-outline-primary"
                onclick="runSource({{ source.id }}, '{{ source.name }}')">
          <i class="bi bi-play me-1"></i> Run Now
        </button>
        {% endif %}
        <a href="/sources" class="btn btn-outline-secondary ms-auto">Cancel</a>
      </div>
    </form>

  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const IS_EDIT = '{{ action }}' === 'edit';
const SOURCE_ID = {{ source.id if source else 'null' }};

document.getElementById('sourceForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const data = {};

  for (const [key, value] of formData.entries()) {
    if (key === 'tags') {
      data[key] = value.split(',').map(t => t.trim()).filter(Boolean);
    } else if (['params', 'pagination', 'field_mapping', 'headers'].includes(key)) {
      try { data[key] = JSON.parse(value || '{}'); }
      catch { showToast(`Invalid JSON in ${key}`, 'danger'); return; }
    } else {
      data[key] = value;
    }
  }

  // Handle unchecked checkboxes
  if (!formData.has('enabled')) data.enabled = false;
  if (!formData.has('api_key_required')) data.api_key_required = false;

  showLoading(true);
  const url = IS_EDIT ? `/api/sources/${SOURCE_ID}` : '/api/sources';
  const method = IS_EDIT ? 'PUT' : 'POST';

  try {
    const resp = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
    });
    const result = await resp.json();
    showLoading(false);
    if (resp.ok) {
      showToast(IS_EDIT ? 'Source updated!' : 'Source created!', 'success');
      setTimeout(() => location.href = '/sources', 1000);
    } else {
      showToast(result.error || 'Save failed', 'danger');
    }
  } catch(err) {
    showLoading(false);
    showToast('Request failed: ' + err.message, 'danger');
  }
});

function testSource(id, name) {
  showToast(`Testing connection...`, 'info');
  fetch(`/api/sources/${id}/test`, { method: 'POST' })
    .then(r => r.json())
    .then(d => showToast(d.success ? `✅ ${d.message}` : `❌ ${d.message}`,
                          d.success ? 'success' : 'danger'));
}

function runSource(id, name) {
  if (!confirm(`Run collection for "${name}" now?`)) return;
  showLoading(true);
  fetch(`/api/sources/${id}/run`, { method: 'POST' })
    .then(r => r.json())
    .then(d => {
      showLoading(false);
      showToast(
        d.status === 'success' ? `✅ Collected ${d.records_stored} records` : `❌ ${d.error}`,
        d.status === 'success' ? 'success' : 'danger'
      );
    })
    .catch(() => { showLoading(false); showToast('Request failed', 'danger'); });
}
</script>
{% endblock %}
