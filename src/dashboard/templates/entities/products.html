{% extends "base.html" %}
{% block title %}Cannabis Products – Cannabis Data Aggregator{% endblock %}
{% block page_title %}Cannabis Products{% endblock %}

{% block topbar_actions %}
  <button class="btn btn-sm btn-primary" onclick="openModal()">
    <i class="bi bi-plus-lg me-1"></i>Add Product
  </button>
  <a href="/entities/import?type=products" class="btn btn-sm btn-outline-success">
    <i class="bi bi-upload me-1"></i>Import
  </a>
  <a href="/api/entities/products?format=csv" class="btn btn-sm btn-outline-secondary">
    <i class="bi bi-download me-1"></i>Export CSV
  </a>
{% endblock %}

{% block extra_css %}
<style>
  .prod-thumb { width:36px; height:36px; object-fit:contain; border-radius:6px; border:1px solid #e0e0e0; background:#f9f9f9; }
  .prod-placeholder { width:36px; height:36px; border-radius:6px; border:1px solid #e0e0e0; background:#f0f0f0;
    display:flex; align-items:center; justify-content:center; color:#bbb; font-size:1rem; }
  #imgPreview { max-height:80px; object-fit:contain; border-radius:6px; display:none; border:1px solid #e0e0e0; margin-top:.5rem; }
  .pct-bar { height:6px; border-radius:3px; background:#e8f5e9; overflow:hidden; }
  .pct-fill { height:100%; border-radius:3px; }
</style>
{% endblock %}

{% block content %}

<div class="card">
  <div class="card-body p-0">
    <table id="tbl" class="table table-hover align-middle mb-0" style="width:100%">
      <thead>
        <tr>
          <th style="width:44px">#</th>
          <th style="width:48px">Image</th>
          <th>Name</th>
          <th>Brand</th>
          <th>Category</th>
          <th>Strain</th>
          <th>THC %</th>
          <th>CBD %</th>
          <th>Price</th>
          <th>State</th>
          <th>Active</th>
          <th>Added</th>
          <th style="width:100px">Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- ── Add / Edit Modal ───────────────────────────────────────────── -->
<div class="modal fade" id="entityModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Add Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="entityId">

        <div class="form-section">
          <div class="form-section-title">Basic Info</div>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Product Name <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="f_name">
            </div>
            <div class="col-md-3">
              <label class="form-label">SKU</label>
              <input type="text" class="form-control" id="f_sku">
            </div>
            <div class="col-md-3">
              <label class="form-label">State (available in)</label>
              <input type="text" class="form-control" id="f_state" maxlength="2" placeholder="CO">
            </div>
            <div class="col-md-6">
              <label class="form-label">Brand</label>
              <select class="form-select" id="f_brand_id">
                <option value="">— None —</option>
                {% for b in brand_options %}
                <option value="{{ b.id }}">{{ b.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Website / Product Page</label>
              <input type="url" class="form-control" id="f_website" placeholder="https://...">
            </div>
            <div class="col-md-6">
              <label class="form-label">Image URL</label>
              <input type="url" class="form-control" id="f_image_url" placeholder="https://..." oninput="previewImg(this,'imgPreview')">
              <img id="imgPreview" alt="product image preview">
            </div>
            <div class="col-md-6 d-flex align-items-end">
              <div class="form-check form-switch ms-1 mb-1">
                <input class="form-check-input" type="checkbox" id="f_is_active" checked>
                <label class="form-check-label" for="f_is_active">Active / Available</label>
              </div>
            </div>
            <div class="col-12">
              <label class="form-label">Description</label>
              <textarea class="form-control" id="f_description" rows="2"></textarea>
            </div>
          </div>
        </div>

        <div class="form-section">
          <div class="form-section-title">Category &amp; Strain</div>
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Category</label>
              <select class="form-select" id="f_category">
                <option value="">— Select —</option>
                <option>Flower</option>
                <option>Pre-Rolls</option>
                <option>Edibles</option>
                <option>Concentrates</option>
                <option>Vapes</option>
                <option>Topicals</option>
                <option>Tinctures</option>
                <option>Capsules</option>
                <option>Beverages</option>
                <option>Accessories</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Subcategory</label>
              <input type="text" class="form-control" id="f_subcategory" placeholder="e.g. Gummies, Wax">
            </div>
            <div class="col-md-4">
              <label class="form-label">Strain Type</label>
              <select class="form-select" id="f_strain_type">
                <option value="">— Select —</option>
                <option>Indica</option>
                <option>Sativa</option>
                <option>Hybrid</option>
                <option>CBD</option>
                <option>Unknown</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Strain Name</label>
              <input type="text" class="form-control" id="f_strain_name" placeholder="e.g. Blue Dream, OG Kush">
            </div>
          </div>
        </div>

        <div class="form-section">
          <div class="form-section-title">Potency &amp; Pricing</div>
          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label">THC %</label>
              <input type="number" step="0.01" min="0" max="100" class="form-control" id="f_thc_percentage" placeholder="e.g. 22.5">
            </div>
            <div class="col-md-3">
              <label class="form-label">CBD %</label>
              <input type="number" step="0.01" min="0" max="100" class="form-control" id="f_cbd_percentage" placeholder="e.g. 0.3">
            </div>
            <div class="col-md-3">
              <label class="form-label">Weight (grams)</label>
              <input type="number" step="0.001" min="0" class="form-control" id="f_weight_grams" placeholder="e.g. 3.5">
            </div>
            <div class="col-md-3">
              <label class="form-label">Price</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="number" step="0.01" min="0" class="form-control" id="f_price" placeholder="0.00">
              </div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Price Unit</label>
              <select class="form-select" id="f_price_unit">
                <option value="">— Select —</option>
                <option>each</option>
                <option>per gram</option>
                <option>per 1/8 oz</option>
                <option>per 1/4 oz</option>
                <option>per 1/2 oz</option>
                <option>per oz</option>
                <option>per pack</option>
                <option>per cartridge</option>
              </select>
            </div>
          </div>
        </div>

        <div class="form-section mb-0">
          <div class="form-section-title">Notes</div>
          <textarea class="form-control" id="f_notes" rows="2"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <div id="modalError" class="text-danger small me-auto" style="display:none"></div>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" id="saveBtn" onclick="saveEntity()">
          <span id="saveBtnText">Save Product</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ── Delete confirm ─────────────────────────────────────────────── -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-body text-center py-4">
        <i class="bi bi-trash3 text-danger" style="font-size:2rem;"></i>
        <p class="mt-2 mb-1 fw-semibold">Delete this product?</p>
        <p class="text-muted small">This action cannot be undone.</p>
      </div>
      <div class="modal-footer justify-content-center">
        <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-danger btn-sm" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
const API = '/api/entities/products';
let table, editingId = null, deletingId = null;

$(document).ready(function () {
  table = $('#tbl').DataTable({
    columns: [
      { data: 'id', width: '44px' },
      { data: 'image_url', orderable: false, render: (v) => v
          ? `<img src="${v}" class="prod-thumb" onerror="this.style.display='none'">`
          : `<div class="prod-placeholder"><i class="bi bi-box-seam"></i></div>` },
      { data: 'name' },
      { data: 'brand_name', defaultContent: '—' },
      { data: 'category', render: (v) => v
          ? `<span class="category-pill" style="background:#fff8e1;color:#e65100">${v}</span>` : '—' },
      { data: null, render: (r) => {
          const parts = [r.strain_name, r.strain_type ? `(${r.strain_type})` : null].filter(Boolean);
          return parts.length ? parts.join(' ') : '—';
        }
      },
      { data: 'thc_percentage', render: (v) => v != null
          ? `<div class="d-flex align-items-center gap-1">
              <div class="pct-bar flex-fill" style="min-width:40px"><div class="pct-fill" style="width:${Math.min(v,100)}%;background:#66bb6a;"></div></div>
              <span class="text-nowrap">${v.toFixed(1)}%</span>
             </div>` : '—' },
      { data: 'cbd_percentage', render: (v) => v != null ? `${v.toFixed(2)}%` : '—' },
      { data: null, render: (r) => {
          if (r.price == null) return '—';
          return `$${parseFloat(r.price).toFixed(2)}${r.price_unit ? ' <span class="text-muted-sm">'+r.price_unit+'</span>' : ''}`;
        }
      },
      { data: 'state', defaultContent: '—' },
      { data: 'is_active', render: (v) => v
          ? '<span class="badge badge-success">Active</span>'
          : '<span class="badge badge-disabled">Inactive</span>' },
      { data: 'created_at', render: (v) => v ? v.split('T')[0] : '—' },
      { data: 'id', orderable: false, render: (id) =>
          `<div class="d-flex gap-1">
            <button class="btn btn-xs btn-outline-primary" onclick="editEntity(${id})" title="Edit"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-xs btn-outline-danger" onclick="confirmDelete(${id})" title="Delete"><i class="bi bi-trash3"></i></button>
          </div>` }
    ],
    order: [[2,'asc']],
    pageLength: 25,
    language: { emptyTable: 'No products yet. Click <strong>Add Product</strong> to get started.' }
  });
  loadData();
});

function loadData() {
  fetch(API).then(r=>r.json()).then(d => {
    if (d.success) table.clear().rows.add(d.data).draw();
  }).catch(console.error);
}

function openModal(data) {
  editingId = data ? data.id : null;
  document.getElementById('modalTitle').textContent  = data ? 'Edit Product' : 'Add Product';
  document.getElementById('saveBtnText').textContent = data ? 'Save Changes' : 'Save Product';
  document.getElementById('modalError').style.display = 'none';

  const strFields = ['name','sku','image_url','website','description','category','subcategory',
                     'strain_name','strain_type','price_unit','state','notes'];
  const numFields = ['thc_percentage','cbd_percentage','price','weight_grams'];
  strFields.forEach(f => {
    const el = document.getElementById('f_' + f);
    if (el) el.value = data ? (data[f] ?? '') : '';
  });
  numFields.forEach(f => {
    const el = document.getElementById('f_' + f);
    if (el) el.value = data ? (data[f] ?? '') : '';
  });
  const brandEl = document.getElementById('f_brand_id');
  if (brandEl) brandEl.value = data?.brand_id ?? '';
  const activeEl = document.getElementById('f_is_active');
  if (activeEl) activeEl.checked = data ? data.is_active : true;

  const prev = document.getElementById('imgPreview');
  if (prev) { prev.src = data?.image_url || ''; prev.style.display = data?.image_url ? 'block' : 'none'; }
  new bootstrap.Modal(document.getElementById('entityModal')).show();
}

function editEntity(id) {
  fetch(`${API}/${id}`).then(r=>r.json()).then(d => { if (d.success) openModal(d.data); });
}

function previewImg(input, previewId) {
  const prev = document.getElementById(previewId);
  if (!prev) return;
  if (input.value) { prev.src = input.value; prev.style.display = 'block'; prev.onerror = () => prev.style.display='none'; }
  else { prev.style.display = 'none'; }
}

function saveEntity() {
  const payload = {};
  ['name','sku','image_url','website','description','category','subcategory',
   'strain_name','strain_type','price_unit','state','notes'].forEach(f => {
    const el = document.getElementById('f_' + f);
    if (el) payload[f] = el.value.trim() || null;
  });
  ['thc_percentage','cbd_percentage','price','weight_grams'].forEach(f => {
    const el = document.getElementById('f_' + f);
    if (el) payload[f] = el.value !== '' ? parseFloat(el.value) : null;
  });
  const brandEl = document.getElementById('f_brand_id');
  payload.brand_id = brandEl?.value ? parseInt(brandEl.value) : null;
  const activeEl = document.getElementById('f_is_active');
  payload.is_active = activeEl ? activeEl.checked : true;

  const errEl = document.getElementById('modalError');
  if (!payload.name) { errEl.textContent = 'Name is required.'; errEl.style.display = 'block'; return; }
  errEl.style.display = 'none';

  const method = editingId ? 'PUT' : 'POST';
  const url    = editingId ? `${API}/${editingId}` : API;
  const btn    = document.getElementById('saveBtn');
  btn.disabled = true;

  fetch(url, { method, headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) })
    .then(r=>r.json()).then(d => {
      btn.disabled = false;
      if (d.success) {
        bootstrap.Modal.getInstance(document.getElementById('entityModal')).hide();
        loadData();
      } else { errEl.textContent = d.error || 'Save failed.'; errEl.style.display = 'block'; }
    }).catch(e => { btn.disabled=false; errEl.textContent=e.message; errEl.style.display='block'; });
}

function confirmDelete(id) {
  deletingId = id;
  new bootstrap.Modal(document.getElementById('deleteModal')).show();
}
document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
  if (!deletingId) return;
  fetch(`${API}/${deletingId}`, { method: 'DELETE' }).then(r=>r.json()).then(d => {
    bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
    if (d.success) loadData();
  });
});
</script>
{% endblock %}
