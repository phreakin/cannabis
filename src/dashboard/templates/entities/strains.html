{% extends "base.html" %}
{% block title %}Cannabis Strains – Cannabis Data Aggregator{% endblock %}
{% block page_title %}Cannabis Strains{% endblock %}

{% block topbar_actions %}
  <button class="btn btn-sm btn-primary" onclick="openModal()">
    <i class="bi bi-plus-lg me-1"></i>Add Strain
  </button>
  <a href="/entities/import?type=strains" class="btn btn-sm btn-outline-success">
    <i class="bi bi-upload me-1"></i>Import
  </a>
  <a href="/api/entities/strains?format=csv" class="btn btn-sm btn-outline-secondary">
    <i class="bi bi-download me-1"></i>Export CSV
  </a>
{% endblock %}

{% block extra_css %}
<style>
  .strain-img { width:36px; height:36px; object-fit:cover; border-radius:6px; border:1px solid #e0e0e0; background:#f9f9f9; }
  .strain-img-placeholder { width:36px; height:36px; border-radius:6px; border:1px solid #e0e0e0; background:#f0f0f0; display:flex; align-items:center; justify-content:center; color:#bbb; }
</style>
{% endblock %}

{% block content %}

<!-- ── Table card ─────────────────────────────────────────────────── -->
<div class="card">
  <div class="card-body p-0">
    <table id="tbl" class="table table-hover align-middle mb-0" style="width:100%">
      <thead>
        <tr>
          <th style="width:44px">#</th>
          <th>Name</th>
          <th>Type</th>
          <th style="width:70px">THC%</th>
          <th style="width:70px">CBD%</th>
          <th>Breeder</th>
          <th>Effects</th>
          <th style="width:100px">Actions</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
</div>

<!-- ── Add / Edit Modal ───────────────────────────────────────────── -->
<div class="modal fade" id="entityModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Add Strain</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="entityId">

        <div class="form-section">
          <div class="form-section-title">Basic Info</div>
          <div class="row g-3">
            <div class="col-md-8">
              <label class="form-label">Name <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="f_name" placeholder="OG Kush">
            </div>
            <div class="col-md-4">
              <label class="form-label">Slug</label>
              <input type="text" class="form-control" id="f_slug" placeholder="og-kush">
            </div>
            <div class="col-md-4">
              <label class="form-label">Strain Type</label>
              <select class="form-select" id="f_strain_type">
                <option value="">— Select —</option>
                <option>Indica</option>
                <option>Sativa</option>
                <option>Hybrid</option>
                <option>CBD</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Breeder</label>
              <input type="text" class="form-control" id="f_breeder">
            </div>
            <div class="col-md-4">
              <label class="form-label">Crosses (parent strains)</label>
              <input type="text" class="form-control" id="f_crosses">
            </div>
            <div class="col-md-12">
              <label class="form-label">Image URL</label>
              <input type="url" class="form-control" id="f_image_url" placeholder="https://...">
            </div>
            <div class="col-12">
              <label class="form-label">Description</label>
              <textarea class="form-control" id="f_description" rows="3"></textarea>
            </div>
          </div>
        </div>

        <div class="form-section">
          <div class="form-section-title">Effects &amp; Flavors</div>
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Effects</label>
              <input type="text" class="form-control" id="f_effects" placeholder="Relaxed, Happy, Euphoric">
            </div>
            <div class="col-12">
              <label class="form-label">Ailments</label>
              <input type="text" class="form-control" id="f_ailments" placeholder="Pain, Stress, Anxiety">
            </div>
            <div class="col-md-6">
              <label class="form-label">Flavors</label>
              <input type="text" class="form-control" id="f_flavors" placeholder="Earthy, Pine, Woody">
            </div>
            <div class="col-md-6">
              <label class="form-label">Terpenes</label>
              <input type="text" class="form-control" id="f_terpenes">
            </div>
          </div>
        </div>

        <div class="form-section mb-0">
          <div class="form-section-title">Cannabinoid Profile</div>
          <div class="row g-3">
            <div class="col-md-3 col-6">
              <label class="form-label">THC%</label>
              <input type="number" step="0.01" min="0" max="100" class="form-control" id="f_thc">
            </div>
            <div class="col-md-3 col-6">
              <label class="form-label">THCA%</label>
              <input type="number" step="0.01" min="0" max="100" class="form-control" id="f_thca">
            </div>
            <div class="col-md-3 col-6">
              <label class="form-label">THCV%</label>
              <input type="number" step="0.01" min="0" max="100" class="form-control" id="f_thcv">
            </div>
            <div class="col-md-3 col-6">
              <label class="form-label">CBD%</label>
              <input type="number" step="0.01" min="0" max="100" class="form-control" id="f_cbd">
            </div>
            <div class="col-md-3 col-6">
              <label class="form-label">CBDA%</label>
              <input type="number" step="0.01" min="0" max="100" class="form-control" id="f_cbda">
            </div>
            <div class="col-md-3 col-6">
              <label class="form-label">CBDV%</label>
              <input type="number" step="0.01" min="0" max="100" class="form-control" id="f_cbdv">
            </div>
            <div class="col-md-3 col-6">
              <label class="form-label">CBN%</label>
              <input type="number" step="0.01" min="0" max="100" class="form-control" id="f_cbn">
            </div>
            <div class="col-md-3 col-6">
              <label class="form-label">CBG%</label>
              <input type="number" step="0.01" min="0" max="100" class="form-control" id="f_cbg">
            </div>
            <div class="col-md-3 col-6">
              <label class="form-label">CBC%</label>
              <input type="number" step="0.01" min="0" max="100" class="form-control" id="f_cbc">
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div id="modalError" class="text-danger small me-auto" style="display:none"></div>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" id="saveBtn" onclick="saveEntity()">
          <span id="saveBtnText">Save Strain</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ── Delete confirm Modal ───────────────────────────────────────── -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-body text-center py-4">
        <i class="bi bi-trash3 text-danger" style="font-size:2rem;"></i>
        <p class="mt-2 mb-1 fw-semibold">Delete this strain?</p>
        <p class="text-muted small">This action cannot be undone.</p>
      </div>
      <div class="modal-footer justify-content-center">
        <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-danger btn-sm" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
const API = '/api/entities/strains';
let table, editingId = null, deletingId = null;

const TYPE_BADGES = {
  'Indica':  'info',
  'Sativa':  'success',
  'Hybrid':  'warning',
  'CBD':     'secondary',
};

function typeBadge(v) {
  if (!v) return '—';
  const cls = TYPE_BADGES[v] || 'secondary';
  return `<span class="badge bg-${cls} text-dark">${v}</span>`;
}

$(document).ready(function () {
  table = $('#tbl').DataTable({
    columns: [
      { data: 'id', width: '44px' },
      { data: 'name' },
      { data: 'strain_type', render: typeBadge },
      { data: 'thc', render: (v) => v != null ? v.toFixed(1) + '%' : '—' },
      { data: 'cbd', render: (v) => v != null ? v.toFixed(1) + '%' : '—' },
      { data: 'breeder', defaultContent: '—' },
      { data: 'effects', render: (v) => {
          if (!v) return '—';
          const truncated = v.length > 60 ? v.substring(0, 60) + '…' : v;
          return `<span title="${v}">${truncated}</span>`;
        }
      },
      { data: 'id', orderable: false, render: (id) =>
          `<div class="d-flex gap-1">
            <button class="btn btn-xs btn-outline-primary" onclick="editEntity(${id})" title="Edit"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-xs btn-outline-danger" onclick="confirmDelete(${id})" title="Delete"><i class="bi bi-trash3"></i></button>
          </div>` },
    ],
    order: [[1, 'asc']],
    pageLength: 25,
    language: { emptyTable: 'No strains yet. Click <strong>Add Strain</strong> or Import to get started.' }
  });
  loadData();
});

function loadData() {
  fetch(API).then(r => r.json()).then(d => {
    if (d.success) { table.clear().rows.add(d.data).draw(); }
  }).catch(console.error);
}

const STR_FIELDS = ['name', 'slug', 'image_url', 'description', 'strain_type',
                    'crosses', 'breeder', 'effects', 'ailments', 'flavors', 'terpenes'];
const NUM_FIELDS = ['thc', 'thca', 'thcv', 'cbd', 'cbda', 'cbdv', 'cbn', 'cbg', 'cbc'];

function openModal(data) {
  editingId = data ? data.id : null;
  document.getElementById('modalTitle').textContent    = data ? 'Edit Strain' : 'Add Strain';
  document.getElementById('saveBtnText').textContent   = data ? 'Save Changes' : 'Save Strain';
  document.getElementById('modalError').style.display = 'none';

  STR_FIELDS.forEach(f => {
    const el = document.getElementById('f_' + f);
    if (el) el.value = data ? (data[f] ?? '') : '';
  });
  NUM_FIELDS.forEach(f => {
    const el = document.getElementById('f_' + f);
    if (el) el.value = data ? (data[f] ?? '') : '';
  });
  new bootstrap.Modal(document.getElementById('entityModal')).show();
}

function editEntity(id) {
  fetch(`${API}/${id}`).then(r => r.json()).then(d => { if (d.success) openModal(d.data); });
}

function saveEntity() {
  const payload = {};
  STR_FIELDS.forEach(f => {
    const el = document.getElementById('f_' + f);
    if (el) payload[f] = el.value.trim() || null;
  });
  NUM_FIELDS.forEach(f => {
    const el = document.getElementById('f_' + f);
    if (el) payload[f] = el.value !== '' ? parseFloat(el.value) : null;
  });

  const errEl = document.getElementById('modalError');
  if (!payload.name) { errEl.textContent = 'Name is required.'; errEl.style.display = 'block'; return; }
  errEl.style.display = 'none';

  const method = editingId ? 'PUT' : 'POST';
  const url    = editingId ? `${API}/${editingId}` : API;
  const btn    = document.getElementById('saveBtn');
  btn.disabled = true;

  fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
    .then(r => r.json())
    .then(d => {
      btn.disabled = false;
      if (d.success) {
        bootstrap.Modal.getInstance(document.getElementById('entityModal')).hide();
        loadData();
      } else {
        errEl.textContent   = d.error || 'Save failed.';
        errEl.style.display = 'block';
      }
    })
    .catch(e => { btn.disabled = false; errEl.textContent = e.message; errEl.style.display = 'block'; });
}

function confirmDelete(id) {
  deletingId = id;
  new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
  if (!deletingId) return;
  fetch(`${API}/${deletingId}`, { method: 'DELETE' })
    .then(r => r.json()).then(d => {
      bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
      if (d.success) loadData();
    });
});
</script>
{% endblock %}
